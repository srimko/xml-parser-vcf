var objHTTP;function WBCEvaluation(pourcentRequis,parcourable,dipl) { this.scoreTotal=0; this.scoreMin=0; this.scoreAtteint=0; this.pourcentageAtteint=0; this.pourcentageRequis=pourcentRequis; this.questions; this.valide=false; this.parcourable=parcourable; this.etatCorrige=false; this.etatRejoue = false; this.ordreAleatoire=false; this.evalPageResultats=true; this.resultatEnvoiLMS=false; this.evalInteraction=false; this.evalSuggestions=false; this.nbMaxPages=-1; this.limiteTheme=false; this.selectionThemes=""; this.formEnvoiReponses=""; this.diplome=dipl; this.evalEnregistreScore=''; this.titreDiplome=''; this.libelleDiplome=''; this.formAffiche=''; this.branchement=''; this.questionnaire=false; this.reponsesPrecedentes=false; this.forcerRepQuestion=true; this.lsPoidsObjectifs=""; this.estJugee=false; this.correctionManuelle=false; this.etatPrecedent=""; this.scorePrecedent=-2; this.stylePgResultats="resultats"; this.frequenceCommit=0; this.commentaires; this.tabIntervalCmt; this.init = EVAL_init; this.ajouterQuestion = EVAL_ajouterQuestion; this.juger = EVAL_juger; this.determinerNiveau = EVAL_determinerNiveau; this.donneCommentaire = EVAL_donneCommentaire; this.allerSuivant = EVAL_allerSuivant; this.donneReponsesQuestion = EVAL_donneReponsesQuestion; this.niveauCertitudeQuestion = EVAL_niveauCertitudeQuestion; this.existeNiveauCertitude = EVAL_existeNiveauCertitude; this.donneFormXML = EVAL_donneFormXML; this.resultatsLMS = EVAL_resultatsLMS; this.numPageSuivante = EVAL_numPageSuivante; this.peutAllerPageResultats = EVAL_peutAllerPageResultats; this.effaceQuestion = EVAL_effaceQuestion; this.genererQuestionsRestantes = EVAL_genererQuestionsRestantes; this.envoieInteractionsLMS = EVAL_envoieInteractionsLMS; this.sortieEvaluation = EVAL_sortieEvaluation;}function EVAL_init(){surSortieEvaluation=false;this.questions = new Array();changeObjectifSecondaire("ATTEMPT_SENT_TO_LMS","unknown");if (oSco.tabDonneesDemarrage!=null){if (oSco.donneeLMS("nbMaxPages")!=""){this.nbMaxPages=parseInt(oSco.donneeLMS("nbMaxPages"));if (oSco.donneeLMS("limiteTheme")!=""){this.limiteTheme=(oSco.donneeLMS("limiteTheme")=="oui");}}if (oSco.donneeLMS("selectionThemes")!=""){this.selectionThemes=oSco.donneeLMS("selectionThemes");}if (oSco.donneeLMS("ordreAleatoire")!=""){this.ordreAleatoire=(oSco.donneeLMS("ordreAleatoire")=="oui");}if (oSco.donneeLMS("evalParcourable")!=""){this.parcourable=(oSco.donneeLMS("evalParcourable")=="oui");}if (oSco.donneeLMS("evalPageResultats")!=""){this.evalPageResultats=(oSco.donneeLMS("evalPageResultats")=="oui");}if (oSco.donneeLMS("reponsesPrecedentes")!=""){this.reponsesPrecedentes=(oSco.donneeLMS("reponsesPrecedentes")=="oui");}if (oSco.donneeLMS("formEnvoiReponses")!=""){this.formEnvoiReponses=oSco.donneeLMS("formEnvoiReponses");}if (oSco.donneeLMS("formAffiche")!=""){this.formAffiche=(oSco.donneeLMS("formAffiche")=="oui");}if (oSco.donneeLMS("evalEnregistreScore")!=""){this.evalEnregistreScore=oSco.donneeLMS("evalEnregistreScore");}if (oSco.donneeLMS("diplome")!=""){this.diplome=(oSco.donneeLMS("diplome")=="oui");}if (oSco.donneeLMS("titreDiplome")!=""){this.titreDiplome=oSco.donneeLMS("titreDiplome");}if (oSco.donneeLMS("libelleDiplome")!=""){this.libelleDiplome=oSco.donneeLMS("libelleDiplome");}} var valMS=APIgetValue("cmi.scaled_passing_score"); if (valMS!=""){ valMS=Number(valMS); if (!isNaN(valMS) && valMS>=0 && valMS<=1){ this.pourcentageRequis=Math.round(valMS*100); }}if (this.pourcentageRequis<=1){this.questionnaire=true;}if (this.nbMaxPages>0){for(var m=0;m<oSco.tabPages.length;m++){if (oSco.tabPages[m].estExercice() && oSco.tabPages[m].prerequis && oSco.tabPages[m].prerequis.indexOf("RESULT")!=0){var mssg="Can't select questions because there are prerequisistes or invisible pages";if (oSco.langue=="fr"){mssg="Impossible de selectionner les questions car il y a des prerequis ou pages invisibles";}alert(mssg);oSco=null;return;}}}if (this.nbMaxPages<0 && this.selectionThemes!=""){this.nbMaxPages=oSco.nbExercices()-1;}var ordrePagesRepris=false;if (this.reponsesPrecedentes && APIgetValue("cmi.entry")!="resume"){var formPrec=SCO_donneAllocation(oSco.identifiant+"_responses","course");if (formPrec!=""){var objDom=creerDOMObj((oSco.config_navigateur=="Netscape"));var succ=objDom.loadXML(formPrec);if (succ){var selectionPages="";if (oSco.tabPages[0].type!="exercice"){selectionPages=oSco.tabPages[0].code;}var lespages=objDom.documentElement.getElementsByTagName("objective");var compteObjIni=SCO_compteCMI("cmi.objectives");for (var i=0;i<lespages.length;i++){var oPage=lespages[i];if (selectionPages!=""){selectionPages+="[;]";}selectionPages+=PF_attr(oPage,"id");var resF=false;if (PF_attr(oPage,"status")=="passed"){resF=true;}var nivCert=-1;if (PF_attr(oPage,"certainty")!=""){nivCert=PF_attr(oPage,"certainty");}var oQuestion = new WBCQuestion(PF_attr(oPage,"id"),XML_texteNoeud(oPage.firstChild),resF,PF_attr(oPage,"score_max"),PF_attr(oPage,"score_raw"),PF_attr(oPage,"score_min"),PF_attr(oPage,"type"),nivCert);oQuestion.init();var lesinter=oPage.getElementsByTagName("interaction");for (var j=0;j<lesinter.length;j++){var oInter=lesinter[j];var reps=PF_attr(oInter,"learner_response");if (PF_attr(oInter,"type")=="long-fill-in"){reps=reps.replace(/\r/g,"");reps=reps.replace(/\\n/g,"\n");}oQuestion.interactions.push(new WBCInteraction(PF_attr(oInter,"id"),PF_attr(oInter,"type"),PF_attr(oInter,"result"),reps,"",""));}this.questions.push(oQuestion);this.scoreTotal+=Number(PF_attr(oPage,"score_max"));this.scoreAtteint+=Number(PF_attr(oPage,"score_raw"));if (PF_attr(oPage,"score_min")!=""){this.scoreMin-=Number(PF_attr(oPage,"score_min"));}if (oSco.autoriserReprise){var numQu=compteObjIni+i;this.envoieInteractionsLMS(oQuestion,numQu,false);}}var nbPages0=oSco.tabPages.length;if (nbPages0>1 && oSco.tabPages[nbPages0-1].type!="exercice"){selectionPages+="[;]"+oSco.tabPages[nbPages0-1].code;}if (this.evalEnregistreScore=='premier'){this.etatCorrige=true;if (this.evalPageResultats){oSco.evaluation.etatRejoue=true;}}if (this.nbMaxPages>0 || this.ordreAleatoire){ordrePagesRepris=true;oSco.tabPages=genererTableauPages(selectionPages);}}}}if (!this.forcerRepQuestion && APIgetValue("cmi.entry")=="ab-initio"){changeObjectifSecondaire("ALL_QUESTIONS_ANSWERED","unknown"); }if (this.nbMaxPages>0 || this.ordreAleatoire){if (APIgetValue("cmi.entry")=="ab-initio"){if (!ordrePagesRepris){if (this.ordreAleatoire){melangerLesFils();}selectionnerExercices(this.nbMaxPages);}if (oSco.autoriserReprise){var lesids="[;]";for (var n=0;n<oSco.tabPages.length;n++){lesids+=oSco.tabPages[n].code+"[;]";}APIsetValue("cmi.suspend_data","selectedPages="+lesids);}}}if (oSco.autoriserReprise && APIgetValue("cmi.entry")=="resume"){if (this.nbMaxPages>0 || this.ordreAleatoire){var tabParmSusp=APIgetValue("cmi.suspend_data").split("##");for (var i=0;i<tabParmSusp.length;i++){if (tabParmSusp[i].indexOf("selectedPages=")==0){oSco.tabPages=genererTableauPages(tabParmSusp[i].substring(14));}}}var nbObjDecl=SCO_compteCMI("cmi.objectives");for (var i=0;i<nbObjDecl;i++){var objCh="cmi.objectives."+i+".";var idObj=APIgetValue(objCh+"id");var npage=oSco.numeroPage(idObj);if (npage>=0){var oPage=oSco.donnePage(npage);oPage.etatVisite=true;var resF=false;if (APIgetValue(objCh+"success_status")=="passed"){resF=true;}var nivCert=-1;var ldesc=APIgetValue(objCh+"description");if (ldesc!=""){var tabPrm=ldesc.split(";");for (var t=0;t<tabPrm.length;t++){if (tabPrm[t].indexOf("certainty:")==0){nivCert=tabPrm[t].substring(10);}}}var oQuestion = new WBCQuestion(idObj,oPage.titre,resF,APIgetValue(objCh+"score.max"),APIgetValue(objCh+"score.raw"),APIgetValue(objCh+"score.min"),oPage.typeExo,nivCert);oQuestion.init();for (var j=0;j<SCO_compteCMI("cmi.interactions");j++){var interCh="cmi.interactions."+j+".";var idInterObj=APIgetValue(interCh+"objectives.0.id");if (idInterObj==idObj){oQuestion.interactions.push(new WBCInteraction(APIgetValue(interCh+"id"),APIgetValue(interCh+"type"),APIgetValue(interCh+"result"),APIgetValue(interCh+"learner_response"),APIgetValue(interCh+"timestamp"),APIgetValue(interCh+"description")));}}this.questions.push(oQuestion);this.scoreTotal+=Number(APIgetValue(objCh+"score.max"));this.scoreAtteint+=Number(APIgetValue(objCh+"score.raw"));this.scoreMin-=Number(APIgetValue(objCh+"score.min"));}}}if (this.evalEnregistreScore=='premier' || this.evalEnregistreScore=='meilleur'){this.etatPrecedent="";var nbObjDecl=SCO_compteCMI("cmi.objectives");for (var i=0;i<nbObjDecl;i++){var objCh="cmi.objectives."+i+".";if (APIgetValue(objCh+"id")=="INIT_RESULT_FROM_OBJ"){var etatObj0=APIgetValue(objCh+"success_status");if (etatObj0=="passed"||etatObj0=="failed"){this.etatPrecedent=etatObj0;}etatObj0=APIgetValue(objCh+"score.scaled");if (etatObj0!=""){this.scorePrecedent=Number(etatObj0);}}}if (this.etatPrecedent==""){this.etatPrecedent=SCO_donneAllocation(oSco.identifiant+"_success_status","course");}if (this.etatPrecedent!=""){if (this.scorePrecedent<-1){var ssp1=SCO_donneAllocation(oSco.identifiant+"_score_scaled","course");if (ssp1!=""){this.scorePrecedent=Number(ssp1);}}APIsetValue("cmi.score.scaled",this.scorePrecedent);APIsetValue("cmi.success_status",this.etatPrecedent);if (this.evalEnregistreScore=='premier'&&(this.etatPrecedent=="passed"||this.etatPrecedent=="failed")){changeObjectifSecondaire("ATTEMPT_ALREADY_SAVED","passed");}if (this.evalEnregistreScore=='meilleur'){changeObjectifSecondaire("IS_BEST_ATTEMPT","unknown");changeObjectifSecondaire("IS_NOT_BEST_ATTEMPT","unknown");}}}}function EVAL_ajouterQuestion(oExo,codePage){var compteObj=SCO_compteCMI("cmi.objectives");var ajoute=compteObj;for (var t=0;t<compteObj;t++){if (APIgetValue("cmi.objectives."+t+".id")==codePage){ajoute=t;}}var ajouteDansTabQuestion=this.questions.length; var remplacement=false;for (var i=0;i<this.questions.length;i++){if (this.questions[i].codePage==codePage){ajouteDansTabQuestion=i;remplacement=true;this.scoreTotal-=this.questions[i].scoreTotal;this.scoreMin+=this.questions[i].scoreMin;this.scoreAtteint-=this.questions[i].scoreAtteint;}} this.scoreTotal+=oExo.scoreTotal;this.scoreMin-=oExo.scoreMin;var scoreUtil=oExo.scoreCourant;if (scoreUtil>oExo.scoreTotal){scoreUtil=oExo.scoreTotal;}this.scoreAtteint+=scoreUtil;var qTmp = new WBCQuestion(codePage,oExo.titre,oExo.valide,oExo.scoreTotal,scoreUtil,oExo.scoreMin,oExo.type,oExo.niveauCertitude);qTmp.init();var tabInteract=oExo.donneTabReponses();for (var j=0;j<tabInteract.length;j++){qTmp.ajouteInteraction(tabInteract[j]);}this.questions[ajouteDansTabQuestion]=qTmp;this.estJugee=false;if (oSco.autoriserReprise){var enrTentative=true;if (this.evalEnregistreScore=="non"){enrTentative=false;}if (this.evalEnregistreScore=="premier" && (this.etatPrecedent=="passed" || this.etatPrecedent=="failed")){enrTentative=false;}if (enrTentative){this.envoieInteractionsLMS(qTmp,ajoute,remplacement);this.frequenceCommit++;if (this.frequenceCommit==3){APIcommit();this.frequenceCommit=0;}}}}function EVAL_envoieInteractionsLMS(qTmp,ajoute,remplacement){var objCh="cmi.objectives."+ajoute+"."; APIsetValue(objCh+"id",qTmp.codePage);APIsetValue(objCh+"completion_status","completed");if (!this.questionnaire){var statut="failed";if (qTmp.valide){statut="passed";}if (qTmp.correctionManuelle){statut="unknown";}APIsetValue(objCh+"success_status",statut);APIsetValue(objCh+"score.raw",qTmp.scoreAtteint);APIsetValue(objCh+"score.max",qTmp.scoreTotal);APIsetValue(objCh+"score.min","0");APIsetValue(objCh+"score.scaled",qTmp.scoreAtteint/qTmp.scoreTotal);} else {APIsetValue(objCh+"success_status","passed");}var champDesc="";if (qTmp.niveauCertitude>=0){champDesc="certainty:"+qTmp.niveauCertitude;}var oPg0=oSco.donnePage(oSco.numeroPage(qTmp.codePage));if (oPg0==null){return;}if (oPg0.theme!=""){if (champDesc!=""){champDesc+=";";}champDesc+="category:"+oPg0.theme;}if (champDesc!=""){APIsetValue(objCh+"description",champDesc);}for (var n=0;n<qTmp.interactions.length;n++){var iTmp =qTmp.interactions[n];var nbInteract=SCO_compteCMI("cmi.interactions");var remplacement=false;for (var k=0;k<nbInteract;k++){if (APIgetValue("cmi.interactions."+k+".id")==iTmp.id){nbInteract=k;remplacement=true;}}var interCh="cmi.interactions."+nbInteract+".";var resSet=APIsetValue(interCh+"id",iTmp.id);if (resSet=="false"){window.status="Can't save interaction "+iTmp.id+" : "+interCh;}if (resSet=="true"){APIsetValue(interCh+"result",iTmp.result);APIsetValue(interCh+"type",iTmp.typeSCORM);APIsetValue(interCh+"timestamp",iTmp.timestamp);APIsetValue(interCh+"learner_response",iTmp.learner_response);/*erreur incomprehensible sur IE9 crash .exe*/if (iTmp.mdescription){APIsetValue(interCh+"description",iTmp.mdescription);}APIsetValue(interCh+"objectives.0.id",qTmp.codePage);}}}function EVAL_juger(){if (!this.forcerRepQuestion){this.genererQuestionsRestantes();}this.scoreAtteint=Math.round(this.scoreAtteint*10)/10;var scoreSup=0;if (this.scoreAtteint>0){scoreSup=this.scoreAtteint;}if (this.scoreTotal>0){this.pourcentageAtteint=Math.round(scoreSup*1000/this.scoreTotal)/10; } else {this.pourcentageAtteint=0;}if (this.pourcentageAtteint>=this.pourcentageRequis){this.valide=true;}this.estJugee=true;}function EVAL_determinerNiveau(){var niveau=-1;var n=0;var precMin=-1;while (n<this.tabIntervalCmt.length){var tabBorne=this.tabIntervalCmt[n].split('-');if (tabBorne.length>2){var min=tabBorne[0];var max=tabBorne[1];if (min!=''&&max!=''){min=Number(min);if (min>precMin){max=Number(max);if (!isNaN(min) && !isNaN(max)){if (this.pourcentageAtteint>=min && this.pourcentageAtteint<=max){niveau=n;precMin=min;this.branchement=tabBorne[2];}}}}}n++;}return niveau;}function EVAL_donneCommentaire(niveau){var txt=this.commentaires[niveau];txt=txt.replace(/\n/g,"<br>");return txt;}function EVAL_allerSuivant(){if (this.etatCorrige){window.contenu.location = RACINE_stage+"contenu/local/"+this.stylePgResultats+"."+oSco.version;} else {var peutJugerEval=true;if (existeExerciceSuivant()){peutJugerEval=false;}var numSuiv=this.numPageSuivante();if (peutJugerEval && numSuiv>0 && oSco.autorisePrecedent=="oui"){peutJugerEval=false;}if (peutJugerEval){if (!this.estJugee){this.juger();this.resultatsLMS();}}if (numSuiv>0){SCO_termineCompteur();SCO_allerPage(numSuiv);} else {this.sortieEvaluation();}}}var surSortieEvaluation=false;function EVAL_sortieEvaluation(){surSortieEvaluation=true;if (!dejaPasse && this.evalPageResultats){surSortieEvaluation=false;}oSco.autorisePrecedent='non';if (!this.estJugee){this.juger();this.resultatsLMS();} else {SCO_termineCompteur();tempsActiviteLimite=0;}var dejaPasse=false;if (this.formEnvoiReponses!=''){if (this.formAffiche=="oui"){dejaPasse=true;window.contenu.location = RACINE_stage+"MosMtr/gen/envoiReponses.htm";} else {initXmlHttp();var chemx=this.formEnvoiReponses;if (chemx.indexOf("://")<0){chemx=RACINE_stage+"sco/"+chemx;}objHTTP.open("POST",chemx,true);objHTTP.onreadystatechange = usrAsyncComplete;objHTTP.send(this.donneFormXML("utf-8"));}}if (!dejaPasse){if (this.evalPageResultats){window.contenu.location = RACINE_stage+"contenu/local/"+this.stylePgResultats+"."+oSco.version;} else {this.determinerNiveau();if (this.branchement==''){if (SCO_suivantPossible()){SCO_pageSuivante();}} else {if (this.branchement.indexOf('/')<0){this.branchement+='/';}window.contenu.GLOBAL_allerPage(this.branchement);}}}}function EVAL_numPageSuivante(){var numChe=oSco.numPageCourante+1;var trouve=false;var oPage=oSco.donnePage(numChe);while (oPage!=null &&!trouve){if (oPage.validePrerequis()){trouve=true;} else {numChe++;oPage=oSco.donnePage(numChe);}}if (!trouve){numChe=-1;}return numChe;}function EVAL_peutAllerPageResultats(){return (this.evalPageResultats && window.contenu.location.href.indexOf("/local/resultats")<0);}function EVAL_donneReponsesQuestion(codePageExo){for (var i=0;i<this.questions.length;i++){if (this.questions[i].codePage==codePageExo){return this.questions[i].interactions;}}return null;}function EVAL_niveauCertitudeQuestion(codePageExo){for (var i=0;i<this.questions.length;i++){if (this.questions[i].codePage==codePageExo){return this.questions[i].niveauCertitude;}}return -1;}function EVAL_existeNiveauCertitude(){for (var i=0;i<this.questions.length;i++){if (this.questions[i].niveauCertitude>=0){return true;}}return false;}function EVAL_donneFormXML(encodage){var idUtil=oSco.idUtil;if (idUtil==""){idUtil="localUser";}var res='<?xml version="1.0" encoding="'+encodage+'"?><mosForm>';var tempsTotalEval=temps_session;var tempTot=APIgetValue("cmi.total_time");if (tempTot!=""){tempsTotalEval=intervalleEnMS(temps_session)+intervalleEnMS(tempTot);tempsTotalEval=formaterSecondes(tempsTotalEval/1000);}res+='<evaluation id="'+oSco.identifiant+'" location="'+masqueTexte(window.location.href)+'" score_raw="'+this.scoreAtteint+'" score_max="'+this.scoreTotal+'" score_min="'+this.scoreMin+'" requiredPercent="'+this.pourcentageRequis+'" passed="'+this.valide+'" lang="'+oSco.langue+'" session_time="'+tempsTotalEval+'" date="'+getDateServeur("")+'">';res+='<title>'+masqueTexte(oSco.titre)+'</title>';res+='<course id="'+oSco.codeStage+'">'+masqueTexte(oSco.titreStage)+'</course>';res+='<student id="'+idUtil+'">'+APIgetValue("cmi.learner_name")+'</student>'; res+='<objectives>';for (var i=0;i<this.questions.length;i++){var oQues=this.questions[i];var statut="failed";if (oQues.valide){statut="passed";}var nivCert="";if (oQues.niveauCertitude>=0){nivCert=' certainty="'+oQues.niveauCertitude+'"';}res+='<objective id="'+oQues.codePage+'" score_raw="'+oQues.scoreAtteint+'" score_max="'+oQues.scoreTotal+'" score_min="'+oQues.scoreMin+'" status="'+statut+'" type="'+oQues.type+'"'+nivCert+'>';res+='<title>'+masqueTexte(oQues.titre)+'</title>';res+='<interactions>';for (var n=0;n<oQues.interactions.length;n++){var oInter=oQues.interactions[n];var student_res=oInter.learner_response;res+='<interaction id="'+oInter.id+'" learner_response="'+masqueTexte(student_res)+'" result="'+oInter.result+'" type="'+oInter.typeSCORM+'" description="'+masqueTexte(oInter.mdescription)+'"/>';}res+='</interactions>';res+='</objective>';}res+="</objectives></evaluation></mosForm>";return res;}function masqueTexte(val){val=val.replace(/&/g,'&amp;');val=val.replace(/"/g,'&quot;');val=val.replace(/\n/g,'\\n');val=val.replace(/\r/g,'');val=val.replace(/</g,'&lt;');val=val.replace(/>/g,'&gt;');return val;}function EVAL_resultatsLMS(){APIsetValue("cmi.completion_status","completed");APIsetValue("cmi.progress_measure","1");var enregistreTentative=true;if (this.evalEnregistreScore=='non'){enregistreTentative=false;} else if (this.evalEnregistreScore=='premier' || this.evalEnregistreScore=='meilleur'){if (this.etatPrecedent=="passed" || this.etatPrecedent=="failed"){if (this.evalEnregistreScore=='premier'){enregistreTentative=false;}else {var estMeilleureTentative="passed";var estPasMeilleureTentative="failed";if (this.scorePrecedent>-2){var scoreU=this.pourcentageAtteint/100;if (this.scorePrecedent>scoreU){enregistreTentative=false;estMeilleureTentative="failed";estPasMeilleureTentative="passed";}}changeObjectifSecondaire("IS_BEST_ATTEMPT",estMeilleureTentative);changeObjectifSecondaire("IS_NOT_BEST_ATTEMPT",estPasMeilleureTentative);}} } if (enregistreTentative){if (this.questionnaire){APIsetValue("cmi.score.scaled","1");APIsetValue("cmi.success_status","passed");} else {var score_scaled=-2; if (this.scoreTotal>0){ score_scaled=this.pourcentageAtteint/100; if (!this.correctionManuelle){APIsetValue("cmi.score.scaled",score_scaled);APIsetValue("cmi.score.raw",this.scoreAtteint);}APIsetValue("cmi.score.max",this.scoreTotal);APIsetValue("cmi.score.min",this.scoreMin);}var etat_succ="failed";if (this.valide){etat_succ="passed";}if (this.correctionManuelle){etat_succ="unknown";try {var hAPI= APIgetHandle();hAPI.cmi.removeAttribute("score_scaled");hAPI.cmi.removeAttribute("success_status");} catch(e){}}APIsetValue("cmi.success_status",etat_succ);if (this.evalEnregistreScore=='premier' || this.evalEnregistreScore=='meilleur'){SCO_modifAllocation(oSco.identifiant+"_success_status",etat_succ,"course");SCO_modifAllocation(oSco.identifiant+"_score_scaled",score_scaled.toString(),"course");}}for (var i=0;i<this.questions.length;i++){if (!oSco.autoriserReprise||this.questions[i].type=="questionVide"){var compteObj=SCO_compteCMI("cmi.objectives");var ajoute=compteObj;for (var t=0;t<compteObj;t++){if (APIgetValue("cmi.objectives."+t+".id")==this.questions[i].codePage){ajoute=t;}}this.envoieInteractionsLMS(this.questions[i],ajoute,false);} }if (this.reponsesPrecedentes){SCO_modifAllocation(oSco.identifiant+"_responses",this.donneFormXML("utf-8"),"course");}var tabThemes=new Array();for (var n=0;n<oSco.tabPages.length;n++){var thExiste=false;var themeTmp=oSco.tabPages[n].theme;if (themeTmp!=""){for (var k=0;k<tabThemes.length;k++){if (tabThemes[k]==themeTmp){thExiste=true;}}if (!thExiste){tabThemes.push(themeTmp);}}}if (tabThemes.length>0){var nbObj=SCO_compteCMI("cmi.objectives");for (var n=0;n<tabThemes.length;n++){var nomTheme=tabThemes[n];for (var i=0;i<nbObj;i++){var objCh="cmi.objectives."+i+".";var idObj=APIgetValue(objCh+"id");if (idObj==encodeURIComponent(nomTheme)){var scoreMaxTh=0;var scoreMinTh=0;var scoreRawTh=0;for (var np=0;np<oSco.tabPages.length;np++){if (oSco.tabPages[np].theme==nomTheme){for (var nq=0;nq<this.questions.length;nq++){if (this.questions[nq].codePage==oSco.tabPages[np].code){var oQu=this.questions[nq];scoreMaxTh+=oQu.scoreTotal;scoreMinTh+=oQu.scoreMin;scoreRawTh+=oQu.scoreAtteint;}}}}if (scoreMaxTh>0){var etatSuccesTh="failed";var pcAtteint=scoreRawTh/scoreMaxTh;if (pcAtteint>=(this.pourcentageRequis/100)){etatSuccesTh="passed";}APIsetValue(objCh+"success_status",etatSuccesTh);var dvsc=pcAtteint.toString();if (dvsc.length>5){dvsc=dvsc.substring(0,5);}APIsetValue(objCh+"score.scaled",dvsc);APIsetValue(objCh+"score.max",scoreMaxTh);APIsetValue(objCh+"score.min",scoreMinTh);APIsetValue(objCh+"score.raw",scoreRawTh);}}}}}changeObjectifSecondaire("ATTEMPT_SENT_TO_LMS","passed");this.resultatEnvoiLMS=true;} else {changeObjectifSecondaire("ATTEMPT_SENT_TO_LMS","failed");if (this.evalEnregistreScore=='non'){APIsetValue("cmi.success_status","passed");}}SCO_termineCompteur();if (oSco.autorisePrecedent!='oui'){tempsActiviteLimite=0;}valeurExit("normal");if (!surSortieEvaluation){APIcommit();}if (oSco.autorisePrecedent!='oui'){temps0=0;}}function usrAsyncComplete() { if(objHTTP.readyState != 4) return(false); usrCheckHTTPStatus("200");}function usrCheckHTTPStatus(sExpected){ if (objHTTP.status != sExpected) { alert("Error "+objHTTP.status+": "+objHTTP.statusText); newWindow = window.open(); newWindow.document.body.innerHTML = objHTTP.responseText; return(false); } else return(true);} /* WBCInteraction */function WBCInteraction(id0,typeSCORM1,result,learner_response,timestamp,description1) { this.id=id0; this.typeSCORM=typeSCORM1; this.result=result; this.learner_response=learner_response.toString(); this.timestamp=timestamp; this.mdescription=description1.toString();}/* WBCQuestion */function WBCQuestion(codePage,titre,valide,scoreTotal,scoreAtteint,scoreMin,type,nivCert){ this.titre=titre; this.valide=valide; this.scoreTotal=scoreTotal; this.scoreAtteint=scoreAtteint; this.scoreMin=scoreMin; this.codePage=codePage; this.type=type; this.correctionManuelle=false; this.niveauCertitude=nivCert; this.interactions; this.ajouteInteraction=WBCQ_ajouteInteraction; this.init=WBCQ_init;}function WBCQ_init(){this.interactions=new Array();}function WBCQ_ajouteInteraction(tabReponses){var typeSCORM="choice";if (this.type=="TAT"){typeSCORM=tabReponses[4];} else if (this.type=="CURS"){typeSCORM="numeric";} else if (this.type=="GD" || this.type=="QM"){typeSCORM="matching";} else if (this.type=="SEQ"){typeSCORM=tabReponses[4];} else if (this.type=="EXP"){typeSCORM=tabReponses[4];}var resultSCORM="incorrect";if (tabReponses[0]){resultSCORM="correct";}if (oSco.evaluation.questionnaire){resultSCORM="neutral";} else if (this.type=="TAT" && tabReponses[3].indexOf("[manualCorrection]")==0){resultSCORM="neutral";this.correctionManuelle=true;oSco.evaluation.correctionManuelle=true;}var dateevt=getDateServeur("")+".0Z";this.interactions.push(new WBCInteraction(this.codePage+"_"+tabReponses[2],typeSCORM,resultSCORM,tabReponses[1],dateevt,tabReponses[3]));}function getDateServeur(mode){var resu='';var dateJS=new Date();var moisServeur="0";var jourServeur="0";var anneeServeur=dateJS.getUTCFullYear();if (dateJS.getUTCMonth()+1<10){moisServeur = moisServeur + (dateJS.getUTCMonth()+1).toString();}else{moisServeur=dateJS.getUTCMonth()+1;}if (dateJS.getUTCDate()<10){jourServeur = jourServeur + (dateJS.getUTCDate()).toString();}else{jourServeur=dateJS.getUTCDate();} if (mode=='yyyymmjj'){ resu=anneeServeur+ "-" + moisServeur + "-" + jourServeur;} else {var heureServeur="0";var minutesServeur="0";var secondesServeur="0"; if (dateJS.getUTCHours()<10){heureServeur+=(dateJS.getUTCHours()).toString();}else {heureServeur=dateJS.getUTCHours();}if (dateJS.getMinutes()<10){minutesServeur+=(dateJS.getMinutes()).toString();}else {minutesServeur=dateJS.getUTCMinutes();}if (dateJS.getSeconds()<10){secondesServeur+=(dateJS.getSeconds()).toString();}else{secondesServeur=dateJS.getUTCSeconds();} resu=anneeServeur+ "-" + moisServeur + "-" + jourServeur + "T" + heureServeur + ":" + minutesServeur + ":" + secondesServeur;}return resu;}function initXmlHttp(){try {objHTTP= new XMLHttpRequest();} catch(e){objHTTP = new ActiveXObject("Msxml2.XMLHTTP");}}function evalVerifPrerequis(val){var res=true;if (val!=''){if (val=='SKIP'){return false;}if (val.indexOf('RESULT')==0){val=val.substring(6);}if (val.length>1){val=val.replace(/&amp;/g,"&");val=val.replace(/pg([\w|%]+)\(/g,"evalTestPre('pg$1',");val=val.replace(/,\)/g,")");try {res=eval(val);} catch(e){res=false;}}}return res;}function evalTestPre(codeP,prm1,prm2,prm3){var rest=false;var oQuestion=null;if (codeP.indexOf("pg00000")==0){codeP=codeP.substring(7);if (codeP=="_primaryObjective"){if (prm1==null || prm1=="undefined"){return (APIgetValue("cmi.success_status")=="passed");}if (prm1=="_score"){var lsca=APIgetValue("cmi.score.scaled");if (lsca==""){return 0;}return Number(lsca)*100;}} else if (codeP=="_currentAssessment"){if (prm1==null || prm1=="undefined"){if (oSco.evaluation.scoreTotal>0){return ((oSco.evaluation.scoreAtteint/oSco.evaluation.scoreTotal)>=oSco.evaluation.pourcentageRequis);}return false;}if (prm1=="_score"){if (oSco.evaluation.scoreTotal>0){return oSco.evaluation.scoreAtteint/oSco.evaluation.scoreTotal*100;}return 0;}} else {var compteObj=SCO_compteCMI("cmi.objectives");var numObjTrouve=-1;for (var t=0;t<compteObj;t++){if (APIgetValue("cmi.objectives."+t+".id")==codeP){numObjTrouve=t;}}if (numObjTrouve>=0){var nomcmi="cmi.objectives."+numObjTrouve+".";if (prm1==null || prm1=="undefined"){return (APIgetValue(nomcmi+"success_status")=="passed");}if (prm1=="_score"){var lsca=APIgetValue(nomcmi+"score.scaled");if (lsca==""){return 0;}return Number(lsca)*100;}if (prm1=="_known"){return (APIgetValue(nomcmi+"success_status")!="unknown");}if (prm1=="_unkn"){return (APIgetValue(nomcmi+"success_status")=="unknown");}} else {alert("Objective "+codeP+" not found in prerequisite");}}return false;}for (var j=0;j<oSco.evaluation.questions.length;j++){if (oSco.evaluation.questions[j].codePage==codeP){oQuestion=oSco.evaluation.questions[j];j=99;}}if (oQuestion!=null && oQuestion.interactions.length>0){if (prm1==null || prm1=="undefined"){return oQuestion.valide;}if (prm1=="_score"){return oQuestion.scoreAtteint;}rest=false;if (oQuestion.type=="QC"||oQuestion.type=="EXP"||oQuestion.type=="SEQ"){var studrep=oQuestion.interactions[0].learner_response;var tabReps=studrep.split("[,]");for (var k=0;k<tabReps.length;k++){if (tabReps[k]==prm1){rest=true;k=99;}}} else if (oQuestion.type=="GD"||oQuestion.type=="QM"){var studrep=oQuestion.interactions[0].learner_response;var tabReps=studrep.split("[,]");for (var k=0;k<tabReps.length;k++){if (tabReps[k]==prm1+"[.]"+prm2){rest=true;k=99;}}} else {var oInter=null;for (var m=0;m<oQuestion.interactions.length;m++){if (oQuestion.interactions[m].id==codeP+"_"+prm1){oInter=oQuestion.interactions[m];}}if (oInter==null){alert(codeP+"_"+prm1+" n'existe pas.");return true;}var studrep=oInter.learner_response;if (oQuestion.type=="TAT"){if (oInter.typeSCORM=="choice"){if (studrep==prm2){rest=true;k=99;}} else {rest=studrep;}} else if (oQuestion.type=="CURS"){rest=studrep;}}}return rest;}function donneTextePre(codeP,prm1){var oQuestion=null;for (var j=0;j<oSco.evaluation.questions.length;j++){if (oSco.evaluation.questions[j].codePage==codeP){oQuestion=oSco.evaluation.questions[j];j=99;}}if (oQuestion==null){return "";}var oInter=null;if (prm1==""){oInter=oQuestion.interactions[0];}for (var m=0;m<oQuestion.interactions.length;m++){if (oQuestion.interactions[m].id==codeP+"_"+prm1){oInter=oQuestion.interactions[m];}}if (oInter==null){alert("Interaction '"+codeP+"."+prm1+"' was not found in prerequisite.");return "";}if ((oInter.typeSCORM=="fill-in"||oInter.typeSCORM=="long-fill-in"||oInter.typeSCORM=="choice") && oInter.mdescription.indexOf("[manualCorrection]")==0){return oInter.mdescription.substring(18);} return oInter.mdescription;}function EVAL_effaceQuestion(codePage){for (var i=0;i<this.questions.length;i++){if (this.questions[i].codePage==codePage){this.questions[i]=null;}} }function redemarrerEval(){oSco.evaluation.questions = new Array();oSco.evaluation.valide=false;oSco.evaluation.etatCorrige=false; oSco.evaluation.etatRejoue = false; oSco.evaluation.scoreAtteint = 0; oSco.evaluation.scoreTotal = 0; oSco.evaluation.scoreMin = 0; for (var i=0;i<oSco.tabPages.length;i++){ oSco.tabPages[i].etatVisite=false; } oSco.evaluation.estJugee=false; SCO_allerPage(0);}function selectionnerExercices(nbMaxExercices){var compte=parseInt(nbMaxExercices);var lesids="[;]";if (compte>0 && compte<oSco.nbExercices()){var debK=0;var idPg=SCO_donneParam("idPg");if (idPg!=""){var num=oSco.numeroPage(idPg);if (oSco.tabPages[num].estExercice()){lesids+=oSco.tabPages[num].code+"[;]";debK=1;}}if (oSco.evaluation.limiteTheme || oSco.evaluation.selectionThemes!=""){var tabThemes=new Array();var limiteGlobaleExo=99999;if (!oSco.evaluation.limiteTheme){limiteGlobaleExo=compte-debK;}for (var n=0;n<oSco.tabPages.length;n++){var thExiste=false;var themeTmp=oSco.tabPages[n].theme;for (var k=0;k<tabThemes.length;k++){if (tabThemes[k]==themeTmp){thExiste=true;}}if (!thExiste){tabThemes.push(themeTmp);}}var tabLimiteThemes=null;if (oSco.evaluation.selectionThemes!=""){tabLimiteThemes=oSco.evaluation.selectionThemes.split(",");}for (var n=0;n<tabThemes.length;n++){var tabPagesTheme=new Array();for (var k=0;k<oSco.tabPages.length;k++){if (tabThemes[n]==oSco.tabPages[k].theme){tabPagesTheme.push(oSco.tabPages[k]);}}var nombreExercicesTheme=0;for (var k=0;k<tabPagesTheme.length;k++){if (tabPagesTheme[k].estExercice()){nombreExercicesTheme++;}}var nbLimParTheme=compte;if (tabLimiteThemes!=null){for (var n2=0;n2<tabLimiteThemes.length;n2++){var rech=tabThemes[n]+":";if (tabLimiteThemes[n2].indexOf(rech)==0){nbLimParTheme=parseInt(tabLimiteThemes[n2].substring(rech.length));break;}}}if (nbLimParTheme<nombreExercicesTheme){for (var h=0;h<nbLimParTheme;h++){var num=Math.floor(Math.random()*tabPagesTheme.length);while (!tabPagesTheme[num].estExercice() || lesids.indexOf("[;]"+tabPagesTheme[num].code+"[;]")>=0){num=Math.floor(Math.random()*tabPagesTheme.length);}if (limiteGlobaleExo>0){lesids+=tabPagesTheme[num].code+"[;]";limiteGlobaleExo--;}}} else {for (var k=0;k<tabPagesTheme.length;k++){if (limiteGlobaleExo>0){lesids+=tabPagesTheme[k].code+"[;]";limiteGlobaleExo--;}}}}} else {for (var k=debK;k<compte;k++){var num=Math.floor(Math.random()*oSco.tabPages.length);while (!oSco.tabPages[num].estExercice() || lesids.indexOf("[;]"+oSco.tabPages[num].code+"[;]")>=0){num=Math.floor(Math.random()*oSco.tabPages.length);}lesids+=oSco.tabPages[num].code+"[;]";}}var nouveauTab=new Array();for (var n=0;n<oSco.tabPages.length;n++){if (!oSco.tabPages[n].estExercice()||lesids.indexOf("[;]"+oSco.tabPages[n].code+"[;]")>=0){nouveauTab.push(oSco.tabPages[n]);}}oSco.tabPages=nouveauTab;}}function melangerLesFils(){var nbPris=0;var nouveauTab=new Array();var lesnums=";";var tailleT=oSco.tabPages.length;var indexDecal=0;if (tailleT>0){var oPrem=oSco.tabPages[0];while (oPrem && !oPrem.estExercice()){nouveauTab[indexDecal]=oPrem;indexDecal++;tailleT--;oPrem=oSco.tabPages[indexDecal];}}var tabDernierCours=new Array();if (tailleT>0){var numZ=oSco.tabPages.length-1;var oPrem=oSco.tabPages[numZ];while (oPrem && !oPrem.estExercice()){tabDernierCours.push(oPrem);numZ--;oPrem=oSco.tabPages[numZ];tailleT--;}}while (nbPris<tailleT){var num=Math.floor(Math.random()*tailleT);num+=indexDecal;if (nbPris==0){var idPg=SCO_donneParam("idPg");if (idPg!=""){var numPgc=oSco.numeroPage(idPg);if (oSco.tabPages[numPgc].estExercice()){num=numPgc;}}}if (lesnums.indexOf(";"+num+";")<0){nouveauTab.push(oSco.tabPages[num]);lesnums+=num+";";nbPris++;}}for (var n=tabDernierCours.length-1;n>=0;n--){nouveauTab.push(tabDernierCours[n]);}oSco.tabPages=nouveauTab;}function EVAL_genererQuestionsRestantes(){if (this.pourcentageRequis>0){var numRest=oSco.numPageCourante;for (var i=0;i<oSco.tabPages.length;i++){var oPage=oSco.tabPages[i];if (oPage.estExercice() && oPage.validePrerequis()){var questionExiste=false;for (var n=0;n<this.questions.length;n++){if (this.questions[n].codePage==oPage.code){questionExiste=true;}}if (!questionExiste){var scoreAj=parseInt(oPage.score);if (isNaN(scoreAj)){scoreAj=10;}this.scoreTotal+=scoreAj;var qTmp = new WBCQuestion(oPage.code,oPage.titre,false,scoreAj,0,0,"questionVide",-1);qTmp.init();this.questions.push(qTmp);}}}}}function creerDOMObj(estMoz){objX=null;if (estMoz){ Document.prototype.loadXML = function(strXML) { var objDOMParser = new DOMParser(); var objDoc = objDOMParser.parseFromString(strXML, "text/xml"); while (this.hasChildNodes()){this.removeChild(this.lastChild);} for (var i=0; i < objDoc.childNodes.length; i++) { try { var objImportedNode = this.importNode(objDoc.childNodes[i], true); this.appendChild(objImportedNode); } catch(e){} } return true; }; objX=document.implementation.createDocument("", "test", null);} else { try {objX=new ActiveXObject("Msxml2.DOMDocument.6.0");} catch (e){objX=new ActiveXObject("Msxml2.DOMDocument.3.0");}}return objX;}function PF_attr(obj,nomAttr){if (obj==null){alert("Null Element for "+nomAttr);}try {val=obj.getAttribute(nomAttr);} catch(e){alert(nomAttr);alert(obj.nodeName);}if (val==null){val="";}return val;}function genererTableauPages(laSel){var nouveauTab=new Array();var tabPagesSusp=laSel.split("[;]");for (var n=0;n<tabPagesSusp.length;n++){if (tabPagesSusp[n]!=""){var npage=oSco.numeroPage(tabPagesSusp[n]);if (npage>=0){nouveauTab.push(oSco.tabPages[npage]);}}}return nouveauTab;}function existeExerciceSuivant(){var numChe=oSco.numPageCourante+1;var oPage=oSco.donnePage(numChe);while (oPage!=null){if (oPage.estExercice() && oPage.validePrerequis()){return true;}numChe++;oPage=oSco.donnePage(numChe);}return false;}function enregistrerRemonteeTm(){setTimeout(enregistrerRemonteeTm2,8000);}function enregistrerRemonteeTm2(){if (parent.API_1484_11.activite){ parent.planLMS.tabDejaFaitRollup=new Array();parent.planLMS.MODE_PREEMPTIF=false; parent.planLMS.overallRollup(parent.API_1484_11.activite); parent.LMS_persisteParcours(true,false); }}function estPageQCResultat(){var oPg=oSco.donnePage(oSco.numPageCourante);return (oPg.prerequis.indexOf('RESULT')==0 && !oSco.evaluation.evalPageResultats);}function estEvalSansResultat(){return (!oSco.evaluation.evalPageResultats && oSco.evaluation.evalEnregistreScore=="non");}
